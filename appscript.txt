function doPost(e) {
  try {
    var ss = SpreadsheetApp.openByUrl(
      "https://docs.google.com/spreadsheets/d/1G1Hvuz9sdgcNMHpqNlOelXjmDLIZIMeCVGd7hald0WA/edit#gid=0"
    );
    var sheet = ss.getSheetByName("ticket");
    var data = e.parameter;

    // ⛔ CHECK ACTION
    if (data.action === "updateTicket") {
      var sn = Number(data.sn);
      var rows = sheet.getDataRange().getValues(); // all rows

      for (var i = 1; i < rows.length; i++) {
        if (Number(rows[i][0]) === sn) {
          // UPDATE SPECIFIC ROW
          sheet.getRange(i + 1, 7).setValue(data.solvedDate);
          sheet.getRange(i + 1, 8).setValue(data.solvedTime);
          sheet.getRange(i + 1, 9).setValue(data.sTime);
          sheet.getRange(i + 1, 10).setValue(data.engName);
          sheet.getRange(i + 1, 11).setValue(data.engNameAnother);
          sheet.getRange(i + 1, 12).setValue(data.remarks);
          sheet.getRange(i + 1, 13).setValue(data.closed);
          sheet.getRange(i + 1, 14).setValue(data.pending);

          return ContentService.createTextOutput(
            JSON.stringify({ status: "updated", sn: sn })
          ).setMimeType(ContentService.MimeType.JSON);
        }
      }

      return ContentService.createTextOutput(
        JSON.stringify({ status: "not_found", sn: sn })
      ).setMimeType(ContentService.MimeType.JSON);
    }

    // ➤ DEFAULT: CREATE NEW TICKET
    var lastRow = sheet.getLastRow();
    var lastSN = 0;

    if (lastRow > 1) {
      var snValue = sheet.getRange(lastRow, 1).getValue();
      snValue = Number(snValue);
      if (!isNaN(snValue)) lastSN = snValue;
    }

    var newSN = lastSN + 1;

    sheet.appendRow([
      newSN,
      data.clientType,
      data.clientName,
      data.issue,
      data.complainDate,
      data.complainTime,
      data.solvedDate,
      data.solvedTime,
      data.sTime,
      data.engName,
      data.engNameAnother,
      data.remarks,
      data.closed,
      data.pending,
    ]);

    return ContentService.createTextOutput(
      JSON.stringify({ status: "created", sn: newSN })
    ).setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    return ContentService.createTextOutput(
      JSON.stringify({ status: "error", message: err.message })
    ).setMimeType(ContentService.MimeType.JSON);
  }
}
